name: Build alinux ISO

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  KERNEL_VERSION: "6.12.1"
  BUSYBOX_VERSION: "1.36.1"
  SEATD_VERSION: "0.8.0"
  WLROOTS_VERSION: "0.18.2"
  WAYLAND_VERSION: "1.23.0"
  WAYLAND_PROTOCOLS_VERSION: "1.36"

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.kernel-cache.outputs.cache-hit }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Cache kernel build
      id: kernel-cache
      uses: actions/cache@v3
      with:
        path: |
          kernel-build/bzImage
          kernel-build/version.txt
        key: kernel-${{ env.KERNEL_VERSION }}-${{ hashFiles('config/kernel.config') }}
        
    - name: Install kernel build dependencies
      if: steps.kernel-cache.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libelf-dev \
          libssl-dev libncurses-dev wget
          
    - name: Build Linux kernel
      if: steps.kernel-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p kernel-build
        cd kernel-build
        
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz
        tar xf linux-${KERNEL_VERSION}.tar.xz
        cd linux-${KERNEL_VERSION}
        
        # Copy config from repo
        cp ../../config/kernel.config .config
        make olddefconfig
        
        echo "Starting kernel build..."
        make -j$(nproc) CFLAGS="-O3 -march=x86-64 -mtune=generic -pipe"
        
        # Debug: show directory structure
        echo "=== Directory structure ==="
        tree -L 3 arch/x86/boot || find arch/x86/boot -type f
        
        # Copy to cache directory
        cp arch/x86/boot/bzImage ../bzImage
        echo "${KERNEL_VERSION}" > ../version.txt
        
    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: kernel-bzImage
        path: kernel-build/bzImage
        retention-days: 1

  build-userspace:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential pkg-config wget cpio \
          ninja-build meson libwayland-dev \
          wayland-protocols libxkbcommon-dev \
          libinput-dev libdrm-dev libgbm-dev \
          libpixman-1-dev libseat-dev libudev-dev
          
    - name: Cache BusyBox build
      id: busybox-cache
      uses: actions/cache@v3
      with:
        path: busybox-build/busybox
        key: busybox-${{ env.BUSYBOX_VERSION }}
        
    - name: Build BusyBox
      if: steps.busybox-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p busybox-build
        cd busybox-build
        
        wget -q https://busybox.net/downloads/busybox-${BUSYBOX_VERSION}.tar.bz2
        tar xf busybox-${BUSYBOX_VERSION}.tar.bz2
        cd busybox-${BUSYBOX_VERSION}
        
        make defconfig
        sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
        
        # Disable tc (traffic control) - requires newer kernel headers
        sed -i 's/CONFIG_TC=y/# CONFIG_TC is not set/' .config
        
        make -j$(nproc)
        
        cp busybox ../busybox
        
    - name: Cache Wayland build
      id: wayland-cache
      uses: actions/cache@v3
      with:
        path: wayland-install/
        key: wayland-${{ env.WAYLAND_VERSION }}-${{ env.WAYLAND_PROTOCOLS_VERSION }}
        
    - name: Build Wayland libraries
      if: steps.wayland-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p wayland-build wayland-install
        cd wayland-build
        
        # Wayland
        wget -q https://gitlab.freedesktop.org/wayland/wayland/-/releases/${WAYLAND_VERSION}/downloads/wayland-${WAYLAND_VERSION}.tar.xz
        tar xf wayland-${WAYLAND_VERSION}.tar.xz
        cd wayland-${WAYLAND_VERSION}
        meson setup build -Dprefix=/usr -Ddocumentation=false
        ninja -C build
        DESTDIR=../../wayland-install ninja -C build install
        cd ..
        
        # Wayland protocols
        wget -q https://gitlab.freedesktop.org/wayland/wayland-protocols/-/releases/${WAYLAND_PROTOCOLS_VERSION}/downloads/wayland-protocols-${WAYLAND_PROTOCOLS_VERSION}.tar.xz
        tar xf wayland-protocols-${WAYLAND_PROTOCOLS_VERSION}.tar.xz
        cd wayland-protocols-${WAYLAND_PROTOCOLS_VERSION}
        meson setup build -Dprefix=/usr
        ninja -C build
        DESTDIR=../../wayland-install ninja -C build install
        
    - name: Cache seatd build
      id: seatd-cache
      uses: actions/cache@v3
      with:
        path: seatd-install/
        key: seatd-${{ env.SEATD_VERSION }}
        
    - name: Build seatd
      if: steps.seatd-cache.outputs.cache-hit != 'true'
      run: |
        set -e
        mkdir -p seatd-install
        wget -q https://git.sr.ht/~kennylevinsen/seatd/archive/${SEATD_VERSION}.tar.gz -O seatd.tar.gz
        tar xf seatd.tar.gz
        cd seatd-${SEATD_VERSION}
        
        # Check available meson options
        echo "=== Available meson options ==="
        meson configure 2>/dev/null || true
        
        # Build seatd (builtin option removed in newer versions)
        if meson setup build -Dprefix=/usr 2>&1 | tee /tmp/meson-setup.log; then
          echo "=== Meson setup successful ==="
        else
          echo "=== Meson setup failed, showing log ==="
          cat build/meson-logs/meson-log.txt 2>/dev/null || cat /tmp/meson-setup.log
          exit 1
        fi
        
        if ninja -C build; then
          echo "=== Ninja build successful ==="
        else
          echo "=== Ninja build failed ==="
          exit 1
        fi
        
        if DESTDIR=../seatd-install ninja -C build install; then
          echo "=== Install successful ==="
        else
          echo "=== Install failed ==="
          exit 1
        fi
        
    - name: Build Azul programs
      run: |
        export PKG_CONFIG_PATH="${PWD}/wayland-install/usr/lib/x86_64-linux-gnu/pkgconfig:${PWD}/wayland-install/usr/lib/pkgconfig:${PWD}/wayland-install/usr/share/pkgconfig"
        
        mkdir -p programs-build
        
        # Build libazul.so
        cd libazul
        gcc -O3 -march=x86-64 -shared -fPIC -o ../programs-build/libazul.so azul.c
        cd ..
        
        # Build introibo installer
        cd introibo
        gcc -O3 -march=x86-64 -o ../programs-build/introibo main.c \
          $(pkg-config --cflags --libs wayland-client) -I../wayland-install/usr/include
        cd ..
        
        # Build alogin
        cd alogin
        gcc -O3 -march=x86-64 -o ../programs-build/alogin main.c \
          $(pkg-config --cflags --libs wayland-client) -I../wayland-install/usr/include
        cd ..
        
        # Build acomp
        cd acomp
        gcc -O3 -march=x86-64 -o ../programs-build/acomp main.c \
          $(pkg-config --cflags --libs wayland-server) -I../wayland-install/usr/include
        cd ..
        
    - name: Upload userspace artifacts
      uses: actions/upload-artifact@v4
      with:
        name: userspace-programs
        path: |
          programs-build/
          busybox-build/busybox
          wayland-install/
          seatd-install/
        retention-days: 1

  build-iso:
    needs: [build-kernel, build-userspace]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install ISO tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cpio genisoimage syslinux isolinux tree
        
    - name: Download kernel
      uses: actions/download-artifact@v4
      with:
        name: kernel-bzImage
        path: artifacts/
        
    - name: Download userspace
      uses: actions/download-artifact@v4
      with:
        name: userspace-programs
        path: artifacts/
        
    - name: Create root filesystem
      run: |
        mkdir -p distro/{bin,sbin,lib,lib64,usr,etc,dev,proc,sys,run,tmp}
        mkdir -p distro/usr/{bin,lib,share}
        mkdir -p distro/etc/init.d
        mkdir -p distro/run/user/0
        
        # Install BusyBox
        cd distro
        cp ../artifacts/busybox-build/busybox bin/busybox
        chmod +x bin/busybox
        
        # Create BusyBox symlinks
        for cmd in $(bin/busybox --list); do
          ln -sf busybox bin/$cmd 2>/dev/null || true
        done
        cd ..
        
        # Install Azul programs
        cp artifacts/programs-build/introibo distro/usr/bin/
        cp artifacts/programs-build/alogin distro/usr/bin/
        cp artifacts/programs-build/acomp distro/usr/bin/
        cp artifacts/programs-build/libazul.so distro/usr/lib/
        chmod +x distro/usr/bin/*
        
        # Install Wayland libraries
        cp -r artifacts/wayland-install/usr/lib/x86_64-linux-gnu/* distro/usr/lib/ 2>/dev/null || true
        cp -r artifacts/wayland-install/usr/lib/* distro/usr/lib/ 2>/dev/null || cp -r artifacts/wayland-install/usr/lib/lib*.so* distro/usr/lib/ 2>/dev/null || true
        
        # Install seatd
        cp -r artifacts/seatd-install/usr/* distro/usr/ 2>/dev/null || true
        
        # Copy system libraries
        for lib in /lib/x86_64-linux-gnu/libc.so.6 \
                   /lib/x86_64-linux-gnu/libm.so.6 \
                   /lib/x86_64-linux-gnu/libpthread.so.0 \
                   /lib/x86_64-linux-gnu/libdl.so.2 \
                   /lib/x86_64-linux-gnu/librt.so.1 \
                   /lib64/ld-linux-x86-64.so.2; do
            [ -f "$lib" ] && cp -L "$lib" distro/lib64/ || true
        done
        
        # Copy additional dependencies
        cp -L /usr/lib/x86_64-linux-gnu/libffi*.so* distro/usr/lib/ 2>/dev/null || true
        cp -L /usr/lib/x86_64-linux-gnu/libexpat*.so* distro/usr/lib/ 2>/dev/null || true
        
    - name: Setup init system
      run: |
        cd distro
        
        # Create device nodes
        sudo mknod -m 666 dev/null c 1 3
        sudo mknod -m 666 dev/zero c 1 5
        sudo mknod -m 666 dev/random c 1 8
        sudo mknod -m 666 dev/urandom c 1 9
        sudo mknod -m 666 dev/tty c 5 0
        sudo mknod -m 666 dev/console c 5 1
        
        # Copy init script from repo
        cp ../config/init init
        chmod +x init
        
        # Copy config files
        cp ../config/fstab etc/fstab
        cp ../config/hostname etc/hostname
        cp ../config/passwd etc/passwd
        cp ../config/group etc/group
        
    - name: Create initramfs
      run: |
        cd distro
        find . | cpio -H newc -o | gzip > ../initramfs.img
        
    - name: Build ISO
      run: |
        mkdir -p iso/boot/{isolinux,kernel}
        
        # Copy kernel
        cp artifacts/bzImage iso/boot/kernel/vmlinuz
        cp initramfs.img iso/boot/kernel/
        
        # Copy bootloader
        cp /usr/lib/ISOLINUX/isolinux.bin iso/boot/isolinux/
        cp /usr/lib/syslinux/modules/bios/ldlinux.c32 iso/boot/isolinux/
        
        # Copy isolinux config from repo
        cp config/isolinux.cfg iso/boot/isolinux/
        
        # Create ISO
        genisoimage -o alinux.iso \
          -b boot/isolinux/isolinux.bin \
          -c boot/isolinux/boot.cat \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          -J -R -V "alinux" \
          iso
          
    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: alinux-iso
        path: alinux.iso
        retention-days: 30
        
    - name: Create release
      if: github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: alinux Build ${{ github.run_number }}
        files: alinux.iso
        body: |
          ## alinux - Build ${{ github.run_number }}
          
          A minimal, high-performance Linux distribution powered by the Azul GUI system.

          ```bash
          # testing
          qemu-system-x86_64 -m 2G -cdrom alinux.iso -enable-kvm
          
          # usb stick
          sudo dd if=alinux.iso of=/dev/sdX bs=1M status=progress
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
