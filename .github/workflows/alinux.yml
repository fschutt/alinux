name: Build alinux ISO

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create release'
        required: false
        default: 'false'
        type: boolean

env:
  KERNEL_VERSION: "6.12.1"
  WLROOTS_VERSION: "0.19.2"
  CAGE_VERSION: "0.2.1"
  LABWC_VERSION: "0.8.2"

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libelf-dev libssl-dev
        
    - name: Cache kernel build
      id: kernel-cache
      uses: actions/cache@v3
      with:
        path: kernel-build/
        key: kernel-${{ env.KERNEL_VERSION }}-v2
        
    - name: Build Linux kernel
      if: steps.kernel-cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p kernel-build
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz
        tar xf linux-${KERNEL_VERSION}.tar.xz
        cd linux-${KERNEL_VERSION}
        
        make defconfig
        
        # Enable essential features
        sed -i 's/# CONFIG_DEVTMPFS is not set/CONFIG_DEVTMPFS=y/' .config
        sed -i 's/# CONFIG_DEVTMPFS_MOUNT is not set/CONFIG_DEVTMPFS_MOUNT=y/' .config
        sed -i 's/# CONFIG_DRM is not set/CONFIG_DRM=y/' .config
        
        echo "Starting kernel build..."
        make -j$(nproc) bzImage modules
        
        cp arch/x86/boot/bzImage ../kernel-build/
        make modules_install INSTALL_MOD_PATH=../kernel-build/modules_install
        
    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-artifacts
        path: kernel-build/
        retention-days: 1

  build-compositors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config ninja-build meson \
            libwayland-dev wayland-protocols libxkbcommon-dev \
            libinput-dev libdrm-dev libgbm-dev libpixman-1-dev \
            libseat-dev libudev-dev libgl1-mesa-dev libvulkan-dev \
            libpci-dev libpng-dev libjpeg-dev libxml2-dev \
            scdoc git hwdata
            
      - name: Cache wlroots
        id: wlroots-cache
        uses: actions/cache@v3
        with:
          path: wlroots-install/
          key: wlroots-${{ env.WLROOTS_VERSION }}
          
      - name: Build wlroots
        if: steps.wlroots-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p wlroots-install
          git clone --depth 1 --branch ${WLROOTS_VERSION} https://gitlab.freedesktop.org/wlroots/wlroots.git
          cd wlroots
          
          meson setup build \
            --prefix=/usr \
            --buildtype=release \
            -Dexamples=false \
            -Dxwayland=enabled
          ninja -C build
          DESTDIR=../wlroots-install ninja -C build install
          
      - name: Cache cage
        id: cage-cache
        uses: actions/cache@v3
        with:
          path: cage-install/
          key: cage-${{ env.CAGE_VERSION }}-wlroots-${{ env.WLROOTS_VERSION }}
          
      - name: Build cage
        if: steps.cage-cache.outputs.cache-hit != 'true'
        run: |
          export PKG_CONFIG_PATH="${PWD}/wlroots-install/usr/lib/x86_64-linux-gnu/pkgconfig:${PWD}/wlroots-install/usr/lib/pkgconfig:${PKG_CONFIG_PATH}"
          
          mkdir -p cage-install
          wget -q https://github.com/cage-kiosk/cage/releases/download/v${CAGE_VERSION}/cage-${CAGE_VERSION}.tar.gz
          tar xf cage-${CAGE_VERSION}.tar.gz
          cd cage-${CAGE_VERSION}
          
          meson setup build \
            --prefix=/usr \
            --buildtype=release \
            -Dxwayland=enabled
          ninja -C build
          DESTDIR=../cage-install ninja -C build install
          
      - name: Cache labwc
        id: labwc-cache
        uses: actions/cache@v3
        with:
          path: labwc-install/
          key: labwc-${{ env.LABWC_VERSION }}-wlroots-${{ env.WLROOTS_VERSION }}
          
      - name: Build labwc
        if: steps.labwc-cache.outputs.cache-hit != 'true'
        run: |
          export PKG_CONFIG_PATH="${PWD}/wlroots-install/usr/lib/x86_64-linux-gnu/pkgconfig:${PWD}/wlroots-install/usr/lib/pkgconfig:${PKG_CONFIG_PATH}"
          
          mkdir -p labwc-install
          wget -q https://github.com/labwc/labwc/archive/refs/tags/${LABWC_VERSION}.tar.gz -O labwc.tar.gz
          tar xf labwc.tar.gz
          cd labwc-${LABWC_VERSION}
          
          meson setup build \
            --prefix=/usr \
            --buildtype=release \
            -Dxwayland=enabled
          ninja -C build
          DESTDIR=../labwc-install ninja -C build install
          
      - name: Upload compositor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compositor-artifacts
          path: |
            wlroots-install/
            cage-install/
            labwc-install/
          retention-days: 1

  build-custom-software:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install library headers
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config \
            libwayland-dev libseat-dev libxkbcommon-dev libinput-dev \
            libdrm-dev libgbm-dev libgl1-mesa-dev libpci-dev libudev-dev
            
      - name: Build Azul programs
        run: |
          mkdir -p programs-build
          
          # Build libazul.so
          cd libazul
          gcc -O3 -march=x86-64 -shared -fPIC -o ../programs-build/libazul.so azul.c
          cd ..
          
          # Build introibo installer
          cd introibo
          gcc -O3 -march=x86-64 -o ../programs-build/introibo main.c \
            $(pkg-config --cflags --libs wayland-client)
          cd ..
          
          # Build alogin
          cd alogin
          gcc -O3 -march=x86-64 -o ../programs-build/alogin main.c \
            $(pkg-config --cflags --libs wayland-client)
          cd ..
          
          # Build acomp (kept for compatibility, but won't be used)
          cd acomp
          gcc -O3 -march=x86-64 -o ../programs-build/acomp main.c \
            $(pkg-config --cflags --libs wayland-server)
          cd ..
          
      - name: Upload custom binaries
        uses: actions/upload-artifact@v4
        with:
          name: azul-binaries
          path: programs-build/

  build-iso:
    needs: [build-kernel, build-compositors, build-custom-software]
    runs-on: ubuntu-latest
    permissions:
      contents: write
  
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ISO creation tools
        run: sudo apt-get update && sudo apt-get install -y cpio genisoimage syslinux isolinux
        
      - name: Download kernel
        uses: actions/download-artifact@v4
        with:
          name: kernel-artifacts
          path: artifacts/kernel
          
      - name: Download compositors
        uses: actions/download-artifact@v4
        with:
          name: compositor-artifacts
          path: artifacts/compositors
          
      - name: Download custom binaries
        uses: actions/download-artifact@v4
        with:
          name: azul-binaries
          path: artifacts/azul
          
      - name: Create Root Filesystem
        run: |
          # 1. Create Directory Structure
          mkdir -p distro/{bin,sbin,usr/bin,usr/sbin,usr/lib,lib64,etc,dev,proc,sys,tmp,run,root,home}
          mkdir -p distro/lib/modules
          mkdir -p distro/etc/xdg/labwc
          
          # 2. Install Kernel Modules
          cp -r artifacts/kernel/modules_install/lib/modules/* distro/lib/modules/
          
          # 3. Install Custom Software (Azul)
          cp artifacts/azul/introibo distro/usr/bin/
          cp artifacts/azul/alogin distro/usr/bin/
          cp artifacts/azul/acomp distro/usr/bin/
          cp artifacts/azul/libazul.so distro/usr/lib/
          chmod +x distro/usr/bin/*
          
          # 4. Install Compositors
          echo "Installing wlroots libraries..."
          cp -r artifacts/compositors/wlroots-install/usr/lib/x86_64-linux-gnu/* distro/usr/lib/ 2>/dev/null || true
          cp -r artifacts/compositors/wlroots-install/usr/lib/* distro/usr/lib/ 2>/dev/null || true
          
          echo "Installing cage..."
          cp artifacts/compositors/cage-install/usr/bin/cage distro/usr/bin/
          chmod +x distro/usr/bin/cage
          
          echo "Installing labwc..."
          cp artifacts/compositors/labwc-install/usr/bin/labwc distro/usr/bin/
          chmod +x distro/usr/bin/labwc
          
          # 5. Copy Host Tools
          TOOLS="bash ls cp mv rm mkdir rmdir cat grep sed awk cut head tail \
                 ps mount umount dmesg chmod chown login id whoami kill sleep \
                 tar gzip bzip2 xz env free df du find xargs uname dirname basename \
                 mknod ln readlink touch echo test tr sort uniq wc less more \
                 date hostname yes which file stat wget curl clear"
          
          echo "Copying host binaries..."
          for tool in $TOOLS; do
            src=$(which $tool 2>/dev/null || echo "")
            if [ -n "$src" ]; then
              cp "$src" distro/bin/
            fi
          done
          
          # Copy sbin tools
          SBIN_TOOLS="ip modprobe insmod lsmod depmod kmod"
          for tool in $SBIN_TOOLS; do
            src=$(which $tool 2>/dev/null || echo "")
            if [ -n "$src" ]; then
              cp "$src" distro/sbin/
            fi
          done
          
          # Create kmod symlinks
          if [ -f distro/sbin/kmod ]; then
             cd distro/sbin
             ln -sf kmod modprobe
             ln -sf kmod insmod
             ln -sf kmod lsmod
             ln -sf kmod depmod
             cd ../..
          fi
          
          # Symlink sh to bash
          cd distro/bin
          ln -sf bash sh
          cd ../..

          # 6. Library Harvester
          echo "Resolving shared libraries..."
          
          copy_lib() {
            local libpath=$1
            if [ -f "$libpath" ]; then
               cp -u -L "$libpath" distro/usr/lib/ 2>/dev/null || true
               cp -u -L "$libpath" distro/lib64/ 2>/dev/null || true
            fi
          }
          
          find distro/bin distro/sbin distro/usr/bin -type f -executable 2>/dev/null | while read binary; do
             ldd "$binary" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read lib; do
                [ -n "$lib" ] && copy_lib "$lib"
             done
             
             ldd "$binary" 2>/dev/null | grep "/ld-linux" | awk '{print $1}' | while read loader; do
                [ -f "$loader" ] && cp -u -L "$loader" distro/lib64/
             done
          done
          
          # Ensure dynamic loader exists
          cp -u /lib64/ld-linux-x86-64.so.2 distro/lib64/ 2>/dev/null || true
          
          # Copy Wayland/Graphics libraries explicitly
          echo "Copying Wayland/Graphics libraries..."
          for lib in /usr/lib/x86_64-linux-gnu/libwayland-*.so* \
                     /usr/lib/x86_64-linux-gnu/libseat*.so* \
                     /usr/lib/x86_64-linux-gnu/libxkbcommon*.so* \
                     /usr/lib/x86_64-linux-gnu/libinput*.so* \
                     /usr/lib/x86_64-linux-gnu/libdrm*.so* \
                     /usr/lib/x86_64-linux-gnu/libudev*.so* \
                     /usr/lib/x86_64-linux-gnu/libevdev*.so* \
                     /usr/lib/x86_64-linux-gnu/libmtdev*.so* \
                     /usr/lib/x86_64-linux-gnu/libffi*.so* \
                     /usr/lib/x86_64-linux-gnu/libpixman*.so* \
                     /usr/lib/x86_64-linux-gnu/libgbm*.so* \
                     /usr/lib/x86_64-linux-gnu/libEGL*.so* \
                     /usr/lib/x86_64-linux-gnu/libGL*.so* \
                     /usr/lib/x86_64-linux-gnu/libpng*.so* \
                     /usr/lib/x86_64-linux-gnu/libjpeg*.so* \
                     /usr/lib/x86_64-linux-gnu/libxml2*.so*; do
            [ -f "$lib" ] && cp -L "$lib" distro/usr/lib/ || true
          done
          
          # Copy Mesa DRI drivers for hardware acceleration
          mkdir -p distro/usr/lib/dri
          cp /usr/lib/x86_64-linux-gnu/dri/*_dri.so distro/usr/lib/dri/ 2>/dev/null || true
          
          # 7. Create labwc default config
          cat <<'EOF' > distro/etc/xdg/labwc/rc.xml
          <?xml version="1.0"?>
          <labwc_config>
            <theme>
              <name>default</name>
            </theme>
            <keyboard>
              <keybind key="A-Tab">
                <action name="NextWindow"/>
              </keybind>
              <keybind key="A-F4">
                <action name="Close"/>
              </keybind>
            </keyboard>
          </labwc_config>
          EOF
          
          # 8. Setup Configuration & Init Scripts
          cat <<'EOF' > distro/init
          #!/bin/bash
          export PATH=/bin:/usr/bin:/sbin:/usr/sbin
          
          # Mount essential filesystems
          /bin/mount -t proc proc /proc
          /bin/mount -t sysfs sysfs /sys
          /bin/mount -t devtmpfs udev /dev
          /bin/mkdir -p /dev/pts /dev/shm
          /bin/mount -t devpts devpts /dev/pts
          /bin/mount -t tmpfs tmpfs /dev/shm
          
          echo "=========================================="
          echo "  Welcome to alinux"
          echo "  Kernel: $(/bin/uname -r)"
          echo "=========================================="
          
          # Set up runtime directory for Wayland
          export XDG_RUNTIME_DIR=/run/user/0
          /bin/mkdir -p $XDG_RUNTIME_DIR
          /bin/chmod 700 $XDG_RUNTIME_DIR
          
          # Check for first boot (installer mode)
          if [ ! -f /etc/.installed ]; then
            echo ""
            echo "First boot detected - launching installer in kiosk mode..."
            /bin/sleep 2
            
            # Launch installer in cage (kiosk compositor)
            if [ -x /usr/bin/cage ] && [ -x /usr/bin/introibo ]; then
              /usr/bin/cage -- /usr/bin/introibo
            else
              echo "ERROR: Cage or introibo not found!"
              /usr/bin/introibo 2>/dev/null || echo "Running without compositor"
            fi
            
            # Mark as installed
            /bin/touch /etc/.installed
            echo ""
            echo "Installation complete. System will now reboot..."
            /bin/sleep 3
            /sbin/reboot
          fi
          
          # Normal boot - show login manager
          echo ""
          echo "Starting login manager..."
          
          if [ -x /usr/bin/cage ] && [ -x /usr/bin/alogin ]; then
            # Run login manager in kiosk mode
            /usr/bin/cage -- /usr/bin/alogin
            
            # After login, check if we should start the desktop
            if [ -f /tmp/.start_desktop ]; then
              echo "Starting desktop environment with labwc..."
              /bin/rm /tmp/.start_desktop
              
              if [ -x /usr/bin/labwc ]; then
                exec /usr/bin/labwc
              else
                echo "labwc not found, dropping to shell"
                exec /bin/bash
              fi
            fi
          else
            echo "Cage or alogin not found, dropping to shell"
            exec /bin/bash
          fi
          
          # Fallback to shell
          exec /bin/bash
          EOF
          chmod +x distro/init
          
      - name: Pack Initramfs
        run: |
          cd distro
          find . | cpio -H newc -o | gzip > ../initramfs.img
          cd ..
          
      - name: Build ISO Image
        run: |
          mkdir -p iso/boot/isolinux iso/boot/kernel
          
          # Copy Kernel & Initramfs
          cp artifacts/kernel/bzImage iso/boot/kernel/vmlinuz
          cp initramfs.img iso/boot/kernel/
          
          # Copy Bootloader
          cp /usr/lib/ISOLINUX/isolinux.bin iso/boot/isolinux/
          cp /usr/lib/syslinux/modules/bios/ldlinux.c32 iso/boot/isolinux/
          
          # Configure Bootloader
          cat > iso/boot/isolinux/isolinux.cfg <<EOF
          default linux
          prompt 0
          timeout 50
          
          label linux
            kernel /boot/kernel/vmlinuz
            append initrd=/boot/kernel/initramfs.img init=/init quiet loglevel=3
          EOF
          
          # Generate ISO
          genisoimage -o alinux.iso \
            -b boot/isolinux/isolinux.bin \
            -c boot/isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -J -R -V "alinux" \
            iso
            
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: alinux-iso
          path: alinux.iso
          retention-days: 10
            
      - name: Create Release
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: alinux Build ${{ github.run_number }}
          files: alinux.iso
          body: |
            ## alinux - Build ${{ github.run_number }}
            
            **Features:**
            - Cage kiosk compositor for installer/login
            - labwc window manager for desktop
            - Custom Azul applications (introibo, alogin)
            - Full GNU tools from Ubuntu 24.04
            - Linux kernel ${{ env.KERNEL_VERSION }}
            
            **Boot sequence:**
            1. First boot → Installer (introibo) in cage kiosk mode
            2. After install → Login manager (alogin) in cage
            3. After login → Desktop with labwc compositor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
