name: Build Introibo Linux ISO

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  KERNEL_VERSION: "6.12.1"
  BUSYBOX_VERSION: "1.36.1"
  SEATD_VERSION: "0.8.0"
  WLROOTS_VERSION: "0.18.2"
  WAYLAND_VERSION: "1.23.0"
  WAYLAND_PROTOCOLS_VERSION: "1.36"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential bc bison flex libelf-dev \
          libssl-dev libncurses-dev cpio genisoimage \
          syslinux isolinux wget ninja-build meson \
          pkg-config libwayland-dev wayland-protocols \
          libxkbcommon-dev libinput-dev libdrm-dev \
          libgbm-dev libpixman-1-dev libseat-dev \
          hwdata libudev-dev libsystemd-dev git
          
    - name: Create build directories
      run: |
        mkdir -p build/{kernel,rootfs,programs,iso}
        mkdir -p distro/{bin,sbin,lib,lib64,usr,etc,dev,proc,sys,run,tmp}
        mkdir -p distro/usr/{bin,lib,share}
        mkdir -p distro/etc/init.d
        mkdir -p distro/run/user/0
        
    - name: Generate optimized kernel config
      run: |
        cat > build/kernel.config << 'EOF'
        CONFIG_64BIT=y
        CONFIG_X86_64=y
        CONFIG_SMP=y
        CONFIG_LOCALVERSION="-introibo"
        
        # CachyOS-style optimizations
        CONFIG_GENERIC_CPU=n
        CONFIG_MZEN4=y
        CONFIG_X86_X2APIC=y
        CONFIG_MICROCODE=y
        CONFIG_MICROCODE_AMD=y
        CONFIG_MICROCODE_INTEL=y
        
        # Aggressive performance
        CONFIG_HZ_1000=y
        CONFIG_HZ=1000
        CONFIG_PREEMPT_VOLUNTARY=y
        CONFIG_NO_HZ_FULL=y
        
        # Essential kernel features
        CONFIG_DEVTMPFS=y
        CONFIG_DEVTMPFS_MOUNT=y
        CONFIG_TMPFS=y
        CONFIG_PROC_FS=y
        CONFIG_SYSFS=y
        CONFIG_TTY=y
        CONFIG_VT=y
        CONFIG_VT_CONSOLE=y
        CONFIG_UNIX=y
        CONFIG_BINFMT_ELF=y
        CONFIG_BLK_DEV_LOOP=y
        
        # DRM/Graphics
        CONFIG_DRM=y
        CONFIG_DRM_FBDEV_EMULATION=y
        CONFIG_FB=y
        CONFIG_FRAMEBUFFER_CONSOLE=y
        CONFIG_LOGO=y
        CONFIG_LOGO_LINUX_CLUT224=y
        CONFIG_DRM_BOCHS=y
        CONFIG_DRM_I915=y
        CONFIG_DRM_AMDGPU=y
        CONFIG_DRM_RADEON=y
        CONFIG_DRM_NOUVEAU=y
        
        # Input devices
        CONFIG_INPUT=y
        CONFIG_INPUT_KEYBOARD=y
        CONFIG_INPUT_MOUSE=y
        CONFIG_INPUT_EVDEV=y
        
        # USB support
        CONFIG_USB_SUPPORT=y
        CONFIG_USB=y
        CONFIG_USB_XHCI_HCD=y
        CONFIG_USB_EHCI_HCD=y
        CONFIG_USB_OHCI_HCD=y
        CONFIG_USB_STORAGE=y
        CONFIG_USB_HID=y
        
        # Networking (for AUR)
        CONFIG_NET=y
        CONFIG_INET=y
        CONFIG_PACKET=y
        CONFIG_UNIX=y
        CONFIG_NETDEVICES=y
        CONFIG_ETHERNET=y
        CONFIG_NET_VENDOR_INTEL=y
        CONFIG_E1000=y
        CONFIG_E1000E=y
        CONFIG_NET_VENDOR_REALTEK=y
        CONFIG_8139TOO=y
        CONFIG_R8169=y
        
        # Filesystem support
        CONFIG_EXT4_FS=y
        CONFIG_EXT4_FS_POSIX_ACL=y
        CONFIG_EXT4_FS_SECURITY=y
        CONFIG_VFAT_FS=y
        CONFIG_FAT_FS=y
        CONFIG_ISO9660_FS=y
        CONFIG_SQUASHFS=y
        
        # Compression
        CONFIG_SQUASHFS_ZLIB=y
        CONFIG_RD_GZIP=y
        CONFIG_DECOMPRESS_GZIP=y
        
        # EFI support
        CONFIG_EFI=y
        CONFIG_EFI_STUB=y
        CONFIG_EFI_VARS=y
        
        # Security
        CONFIG_SECURITY=y
        CONFIG_SECURITYFS=y
        EOF
        
    - name: Download and build Linux kernel
      run: |
        cd build/kernel
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz
        tar xf linux-${KERNEL_VERSION}.tar.xz
        cd linux-${KERNEL_VERSION}
        
        # Use optimized config
        cp ../../../build/kernel.config .config
        make olddefconfig
        
        # Build with optimizations
        make -j$(nproc) CFLAGS="-O3 -march=native -mtune=native -pipe"
        
        cp arch/x86/boot/bzImage ../../../../distro/vmlinuz
        
    - name: Build BusyBox
      run: |
        cd build/rootfs
        wget -q https://busybox.net/downloads/busybox-${BUSYBOX_VERSION}.tar.bz2
        tar xf busybox-${BUSYBOX_VERSION}.tar.bz2
        cd busybox-${BUSYBOX_VERSION}
        
        make defconfig
        sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
        make -j$(nproc)
        make CONFIG_PREFIX=../../../../distro install
        
    - name: Build seatd
      run: |
        cd build/programs
        wget -q https://git.sr.ht/~kennylevinsen/seatd/archive/${SEATD_VERSION}.tar.gz -O seatd.tar.gz
        tar xf seatd.tar.gz
        cd seatd-${SEATD_VERSION}
        
        meson setup build -Dprefix=/usr -Dbuiltin=enabled
        ninja -C build
        DESTDIR=../../../../distro ninja -C build install
        
    - name: Build Wayland libraries
      run: |
        cd build/programs
        
        # Wayland
        wget -q https://gitlab.freedesktop.org/wayland/wayland/-/releases/${WAYLAND_VERSION}/downloads/wayland-${WAYLAND_VERSION}.tar.xz
        tar xf wayland-${WAYLAND_VERSION}.tar.xz
        cd wayland-${WAYLAND_VERSION}
        meson setup build -Dprefix=/usr -Ddocumentation=false
        ninja -C build
        DESTDIR=../../../../distro ninja -C build install
        cd ..
        
        # Wayland protocols
        wget -q https://gitlab.freedesktop.org/wayland/wayland-protocols/-/releases/${WAYLAND_PROTOCOLS_VERSION}/downloads/wayland-protocols-${WAYLAND_PROTOCOLS_VERSION}.tar.xz
        tar xf wayland-protocols-${WAYLAND_PROTOCOLS_VERSION}.tar.xz
        cd wayland-protocols-${WAYLAND_PROTOCOLS_VERSION}
        meson setup build -Dprefix=/usr
        ninja -C build
        DESTDIR=../../../../distro ninja -C build install
        
    - name: Create introibo installer program
      run: |
        cat > build/programs/introibo.c << 'EOF'
        #include <wayland-client.h>
        #include <stdio.h>
        #include <stdlib.h>
        #include <string.h>
        #include <unistd.h>

        static struct wl_display *display = NULL;
        static struct wl_compositor *compositor = NULL;
        static struct wl_surface *surface = NULL;

        static void registry_global(void *data, struct wl_registry *registry,
                                   uint32_t name, const char *interface, uint32_t version) {
            if (strcmp(interface, wl_compositor_interface.name) == 0) {
                compositor = wl_registry_bind(registry, name, &wl_compositor_interface, 1);
            }
        }

        static void registry_global_remove(void *data, struct wl_registry *registry, uint32_t name) {}

        static const struct wl_registry_listener registry_listener = {
            .global = registry_global,
            .global_remove = registry_global_remove,
        };

        int main(int argc, char *argv[]) {
            printf("=== Introibo Linux Installer ===\n");
            printf("Welcome to Introibo Linux!\n\n");
            
            display = wl_display_connect(NULL);
            if (!display) {
                fprintf(stderr, "Failed to connect to Wayland display\n");
                printf("Running in text mode...\n\n");
                printf("Installation options:\n");
                printf("1. Install to disk\n");
                printf("2. Live session\n");
                printf("3. Configure system\n");
                printf("\nSelect option (1-3): ");
                
                char input[10];
                if (fgets(input, sizeof(input), stdin)) {
                    printf("You selected: %s", input);
                }
                return 0;
            }

            struct wl_registry *registry = wl_display_get_registry(display);
            wl_registry_add_listener(registry, &registry_listener, NULL);
            wl_display_roundtrip(display);

            if (compositor) {
                surface = wl_compositor_create_surface(compositor);
                printf("Wayland compositor connected successfully!\n");
                printf("Graphical installer ready.\n");
            }

            wl_display_roundtrip(display);
            
            if (surface) wl_surface_destroy(surface);
            if (compositor) wl_compositor_destroy(compositor);
            wl_registry_destroy(registry);
            wl_display_disconnect(display);
            
            return 0;
        }
        EOF
        
        gcc -O3 -march=native -o distro/usr/bin/introibo build/programs/introibo.c \
          $(pkg-config --cflags --libs wayland-client) -lwayland-client
        
    - name: Create login manager
      run: |
        cat > build/programs/login-manager.c << 'EOF'
        #include <wayland-client.h>
        #include <stdio.h>
        #include <stdlib.h>
        #include <string.h>
        #include <unistd.h>

        static struct wl_display *display = NULL;
        static struct wl_compositor *compositor = NULL;

        static void registry_global(void *data, struct wl_registry *registry,
                                   uint32_t name, const char *interface, uint32_t version) {
            if (strcmp(interface, wl_compositor_interface.name) == 0) {
                compositor = wl_registry_bind(registry, name, &wl_compositor_interface, 1);
            }
        }

        static void registry_global_remove(void *data, struct wl_registry *registry, uint32_t name) {}

        static const struct wl_registry_listener registry_listener = {
            .global = registry_global,
            .global_remove = registry_global_remove,
        };

        int main(int argc, char *argv[]) {
            printf("=== Introibo Login Manager ===\n");
            
            display = wl_display_connect(NULL);
            if (!display) {
                fprintf(stderr, "Wayland display not available\n");
                printf("Username: ");
                char username[256];
                if (fgets(username, sizeof(username), stdin)) {
                    printf("Welcome, %s", username);
                }
                return 0;
            }

            struct wl_registry *registry = wl_display_get_registry(display);
            wl_registry_add_listener(registry, &registry_listener, NULL);
            wl_display_roundtrip(display);

            printf("Login manager initialized with Wayland support\n");
            
            wl_registry_destroy(registry);
            wl_display_disconnect(display);
            return 0;
        }
        EOF
        
        gcc -O3 -march=native -o distro/usr/bin/login-manager build/programs/login-manager.c \
          $(pkg-config --cflags --libs wayland-client) -lwayland-client
        
    - name: Create simple Wayland compositor
      run: |
        cat > build/programs/compositor.c << 'EOF'
        #include <wayland-server.h>
        #include <stdio.h>
        #include <stdlib.h>
        #include <signal.h>

        static struct wl_display *display = NULL;
        static bool running = true;

        static void handle_signal(int sig) {
            running = false;
        }

        int main(int argc, char *argv[]) {
            printf("=== Introibo Wayland Compositor ===\n");
            
            signal(SIGINT, handle_signal);
            signal(SIGTERM, handle_signal);
            
            display = wl_display_create();
            if (!display) {
                fprintf(stderr, "Failed to create Wayland display\n");
                return 1;
            }

            const char *socket = wl_display_add_socket_auto(display);
            if (!socket) {
                fprintf(stderr, "Failed to add socket\n");
                wl_display_destroy(display);
                return 1;
            }

            printf("Compositor running on socket: %s\n", socket);
            setenv("WAYLAND_DISPLAY", socket, 1);
            
            printf("Press Ctrl+C to stop\n");
            
            while (running) {
                wl_display_flush_clients(display);
                wl_event_loop_dispatch(wl_display_get_event_loop(display), 100);
            }
            
            printf("\nShutting down compositor...\n");
            wl_display_destroy(display);
            
            return 0;
        }
        EOF
        
        gcc -O3 -march=native -o distro/usr/bin/introibo-compositor build/programs/compositor.c \
          $(pkg-config --cflags --libs wayland-server) -lwayland-server
        
    - name: Create libazul.so stub
      run: |
        cat > build/programs/libazul.c << 'EOF'
        #include <stdio.h>

        void azul_init(void) {
            printf("libazul v1.0.0 initialized\n");
        }

        const char* azul_version(void) {
            return "1.0.0-introibo";
        }

        int azul_render(void) {
            return 0;
        }
        EOF
        
        gcc -O3 -march=native -shared -fPIC -o distro/usr/lib/libazul.so build/programs/libazul.c
        
    - name: Setup rootfs structure
      run: |
        cd distro
        
        # Create essential device nodes
        sudo mknod -m 666 dev/null c 1 3
        sudo mknod -m 666 dev/zero c 1 5
        sudo mknod -m 666 dev/random c 1 8
        sudo mknod -m 666 dev/urandom c 1 9
        sudo mknod -m 666 dev/tty c 5 0
        sudo mknod -m 666 dev/console c 5 1
        
        # Create init script
        cat > init << 'INITEOF'
        #!/bin/sh
        
        export PATH=/bin:/sbin:/usr/bin:/usr/sbin
        
        mount -t proc proc /proc
        mount -t sysfs sysfs /sys
        mount -t devtmpfs devtmpfs /dev
        mount -t tmpfs tmpfs /tmp
        
        mkdir -p /dev/shm /dev/pts
        mount -t tmpfs tmpfs /dev/shm
        mount -t devpts devpts /dev/pts
        
        export XDG_RUNTIME_DIR=/run/user/0
        mkdir -p "$XDG_RUNTIME_DIR"
        chmod 700 "$XDG_RUNTIME_DIR"
        
        # Start seatd
        /usr/bin/seatd -g video &
        sleep 1
        
        # Launch installer on first boot
        if [ ! -f /etc/.installed ]; then
            clear
            /usr/bin/introibo
            echo "Press Enter to continue..."
            read
        fi
        
        # Start compositor in background
        /usr/bin/introibo-compositor &
        COMPOSITOR_PID=$!
        sleep 1
        
        # Start login manager
        /usr/bin/login-manager
        
        # Drop to shell
        exec /bin/sh
        INITEOF
        
        chmod +x init
        
        # Create fstab
        cat > etc/fstab << 'EOF'
        proc /proc proc defaults 0 0
        sysfs /sys sysfs defaults 0 0
        devtmpfs /dev devtmpfs defaults 0 0
        EOF
        
        # Create hostname
        echo "introibo" > etc/hostname
        
        # Create basic passwd
        cat > etc/passwd << 'EOF'
        root:x:0:0:root:/root:/bin/sh
        EOF
        
        # Create group file
        cat > etc/group << 'EOF'
        root:x:0:
        video:x:44:
        EOF
        
    - name: Copy system libraries
      run: |
        # Copy essential libraries
        mkdir -p distro/lib64 distro/usr/lib
        
        for lib in /lib/x86_64-linux-gnu/libc.so.6 \
                   /lib/x86_64-linux-gnu/libm.so.6 \
                   /lib/x86_64-linux-gnu/libpthread.so.0 \
                   /lib/x86_64-linux-gnu/libdl.so.2 \
                   /lib/x86_64-linux-gnu/librt.so.1 \
                   /lib64/ld-linux-x86-64.so.2; do
            if [ -f "$lib" ]; then
                cp -L "$lib" distro/lib64/ || true
            fi
        done
        
        # Copy wayland libraries
        cp -rL /usr/lib/x86_64-linux-gnu/libwayland-*.so* distro/usr/lib/ || true
        cp -rL /usr/lib/x86_64-linux-gnu/libffi*.so* distro/usr/lib/ || true
        cp -rL /usr/lib/x86_64-linux-gnu/libexpat*.so* distro/usr/lib/ || true
        
    - name: Install AUR prerequisites
      run: |
        cd distro/usr/bin
        
        # Copy git
        cp /usr/bin/git .
        
        # Copy make and build tools
        cp /usr/bin/make .
        cp /usr/bin/gcc .
        cp /usr/bin/g++ .
        cp /usr/bin/ld .
        
        # Copy pacman stub (future AUR support)
        cat > pacman << 'EOF'
        #!/bin/sh
        echo "Introibo AUR wrapper v1.0"
        echo "Usage: pacman -S <package>"
        echo "AUR support coming soon!"
        EOF
        chmod +x pacman
        
    - name: Create initramfs
      run: |
        cd distro
        find . | cpio -H newc -o | gzip > ../build/iso/initramfs.img
        
    - name: Create bootable ISO
      run: |
        mkdir -p build/iso/boot/isolinux
        
        # Copy kernel
        cp distro/vmlinuz build/iso/boot/
        
        # Copy syslinux files
        cp /usr/lib/ISOLINUX/isolinux.bin build/iso/boot/isolinux/
        cp /usr/lib/syslinux/modules/bios/ldlinux.c32 build/iso/boot/isolinux/
        
        # Create isolinux config
        cat > build/iso/boot/isolinux/isolinux.cfg << 'EOF'
        DEFAULT introibo
        PROMPT 0
        TIMEOUT 50
        
        LABEL introibo
            KERNEL /boot/vmlinuz
            APPEND initrd=/boot/initramfs.img quiet loglevel=3
        EOF
        
        # Create ISO
        genisoimage -o introibo-linux.iso \
          -b boot/isolinux/isolinux.bin \
          -c boot/isolinux/boot.cat \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          -J -R -V "Introibo Linux" \
          build/iso
          
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: introibo-linux-iso
        path: introibo-linux.iso
        retention-days: 30
        
    - name: Create release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Introibo Linux Build ${{ github.run_number }}
        files: introibo-linux.iso
        body: |
          ## Introibo Linux - Build ${{ github.run_number }}
          
          A minimal, optimized Linux distribution with:
          - Custom Wayland compositor
          - Graphical installer (introibo)
          - Login manager
          - AUR support (via pacman wrapper)
          - CachyOS-inspired kernel optimizations
          - libazul.so preinstalled
          
          ### Testing
          ```bash
          qemu-system-x86_64 -m 2G -cdrom introibo-linux.iso -enable-kvm
          ```
          
          ### Boot on real hardware
          Write to USB: `dd if=introibo-linux.iso of=/dev/sdX bs=1M`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
